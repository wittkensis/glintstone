{% extends "base.html" %}
{% from "components/_macros.html" import tablet_card, stage_filter, filter_sidebar, pagination %}

{% block title %}Tablets - Glintstone{% endblock %}

{% block content %}
<main class="layout-two-column filtered-list-page">
<div class="page-with-sidebar">
    {{ filter_sidebar(
        search_value=search or '',
        action_url='/tablets',
        pipeline=pipeline or '',
        period=period or [],
        provenience=provenience or [],
        genre=genre or [],
        language=language or [],
        has_ocr=has_ocr or '',
        filter_options=filter_options
    ) }}

    <div class="main-content">
        <div class="page-header">
            <div class="page-header-main">
                <div class="page-header-title">
                    <h1>Tablets</h1>
                    <p class="subtitle">
                        Showing {{ '{:,}'.format(total) }} tablets
                    </p>
                </div>
            </div>
        </div>

        {# Build filter query string for stage filter + pagination links #}
        {% set fq = namespace(s='') %}
        {% if search %}{% set fq.s = fq.s ~ 'search=' ~ (search|urlencode) ~ '&' %}{% endif %}
        {% for p in period %}{% set fq.s = fq.s ~ 'period=' ~ (p|urlencode) ~ '&' %}{% endfor %}
        {% for p in provenience %}{% set fq.s = fq.s ~ 'provenience=' ~ (p|urlencode) ~ '&' %}{% endfor %}
        {% for g in genre %}{% set fq.s = fq.s ~ 'genre=' ~ (g|urlencode) ~ '&' %}{% endfor %}
        {% for l in language %}{% set fq.s = fq.s ~ 'language=' ~ (l|urlencode) ~ '&' %}{% endfor %}
        {% if has_ocr %}{% set fq.s = fq.s ~ 'has_ocr=1&' %}{% endif %}

        {% set stages = [
            {'label': 'All', 'value': ''},
            {'label': 'Needs transliteration', 'value': 'needs_reading'},
            {'label': 'Needs lemmatization', 'value': 'needs_linguistic'},
            {'label': 'Complete', 'value': 'complete'},
        ] %}
        {{ stage_filter(stages, pipeline or '', '/tablets', extra_params=fq.s, has_ocr=has_ocr or '') }}

        {# Active filter pills #}
        {% if active_filters %}
        <div class="active-filters">
            <div class="active-filters__pills">
                {% for f in active_filters %}
                <a href="{{ f.remove_url }}" class="filter-pill">
                    <span class="filter-pill__label">{{ f.label }}</span>
                    <span class="filter-pill__remove" aria-label="Remove">&times;</span>
                </a>
                {% endfor %}
            </div>
            <a href="/tablets{% if pipeline %}?pipeline={{ pipeline }}{% endif %}" class="active-filters__clear">Clear all</a>
        </div>
        {% endif %}

        <div class="tablet-grid">
            {% for tablet in tablets %}
                {{ tablet_card(tablet, api_url=api_url) }}
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">&#x12000;</div>
                <h3>No tablets found</h3>
                <p>Try adjusting your search or filters.</p>
            </div>
            {% endfor %}
        </div>

        {% set base = '/tablets?' ~ fq.s %}
        {% if pipeline %}{% set base = base ~ 'pipeline=' ~ pipeline ~ '&' %}{% endif %}
        {{ pagination(page, total_pages, base) }}
    </div>
</div>
</main>
{% endblock %}
