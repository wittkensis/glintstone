{% extends "base.html" %}
{% from "components/_macros.html" import pipeline, lang_badge, ocr_badge %}

{% block title %}{{ tablet.p_number }} - Glintstone{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/components/atf-viewer/index.css">
{% endblock %}

{% block content %}
<header class="page-header tablet-header">
    {% if tablet.composites %}
    <div class="composite-panel" id="composite-panel" data-q-number="{{ tablet.composites[0].q_number }}">
        <div class="composite-panel__header">
            <div class="composite-panel__title-group">
                <h2 class="composite-panel__title">{{ tablet.composites[0].designation or tablet.composites[0].q_number }}</h2>
                {% if tablet.composites[0].designation %}
                <span class="composite-panel__subtitle">{{ tablet.composites[0].q_number }}</span>
                {% endif %}
            </div>
            <span class="composite-panel__count" id="composite-count">{{ tablet.composites[0].exemplar_count or '?' }} tablets</span>
        </div>
        <div class="composite-panel__list" id="composite-list">
            <div class="composite-panel__loading">Loading tablets...</div>
        </div>
    </div>
    {% endif %}

    <div class="page-header-main">
        <div class="page-header-title">
            <h1>{{ tablet.p_number }}</h1>
        </div>
        <div class="page-header-actions">
                    {% set pipe = tablet.pipeline or {} %}
                    {{ pipeline(pipe, 'inline') }}
                    {{ ocr_badge(tablet.graphemic_complete) }}

                    {% if tablet.composites %}
                    <button class="btn btn--icon-left btn--toggle" id="composite-toggle"
                            aria-expanded="false" aria-controls="composite-panel"
                            title="View composite text">
                        <span>{{ tablet.composites[0].designation or tablet.composites[0].q_number }}</span>
                    </button>
                    {% endif %}

                    <div class="actions-menu">
                        <button class="btn btn--icon actions-menu__trigger" aria-haspopup="true" aria-expanded="false">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                            </svg>
                        </button>
                        <div class="actions-menu__dropdown">
                            <a href="https://cdli.earth/artifacts/{{ tablet.p_number[1:] | int }}"
                               target="_blank" class="actions-menu__item">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                                View on CDLI
                            </a>
                            <a href="https://cdli.earth/artifacts/{{ tablet.p_number[1:] | int }}/history"
                               target="_blank" class="actions-menu__item">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                </svg>
                                View history on CDLI
                            </a>
                        </div>
            </div>
        </div>
    </div>

    {# Primary Metadata #}
    {% set has_attribution = tablet.atf_source or tablet.translation_source or tablet.publication_author %}
    {% set has_oracc_credits = tablet.oracc_credits and tablet.oracc_credits | length > 0 %}
    {% set has_secondary = tablet.designation or tablet.museum_no or tablet.genre or (tablet.width and tablet.height) or has_attribution or has_oracc_credits %}
    <div class="page-header-metadata tablet-meta">
            <dl class="tablet-meta__row">
                {% if tablet.language %}
                <div class="meta-item">
                    <dt>Language</dt>
                    <dd>{{ tablet.language }}</dd>
                </div>
                {% endif %}
                {% if tablet.period %}
                <div class="meta-item">
                    <dt>Period</dt>
                    <dd>{{ tablet.period }}</dd>
                </div>
                {% endif %}
                {% if tablet.provenience %}
                <div class="meta-item">
                    <dt>Provenience</dt>
                    <dd>{{ tablet.provenience }}</dd>
                </div>
                {% endif %}
                {% if tablet.excavation_no %}
                <div class="meta-item">
                    <dt>Excavation</dt>
                    <dd>{{ tablet.excavation_no }}</dd>
                </div>
                {% endif %}
                {% if has_secondary %}
                <div class="meta-item">
                    <button class="tablet-meta__toggle" id="meta-toggle" aria-expanded="false" aria-controls="meta-secondary">
                        <svg class="tablet-meta__toggle-icon" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                        More
                    </button>
                </div>
                {% endif %}
            </dl>

            {# Compact attribution — always visible #}
            {% if tablet.atf_source %}
            <p class="tablet-meta__attribution">
                Data by {{ tablet.atf_source }}
            </p>
            {% endif %}

            {% if has_secondary %}
            <dl class="tablet-meta__secondary" id="meta-secondary">
                {% if tablet.designation %}
                <div class="meta-item">
                    <dt>Designation</dt>
                    <dd>{{ tablet.designation }}</dd>
                </div>
                {% endif %}
                {% if tablet.museum_no %}
                <div class="meta-item">
                    <dt>Museum</dt>
                    <dd>{{ tablet.museum_no }}</dd>
                </div>
                {% endif %}
                {% if tablet.genre %}
                <div class="meta-item">
                    <dt>Genre</dt>
                    <dd>{{ tablet.genre }}</dd>
                </div>
                {% endif %}
                {% if tablet.width and tablet.height %}
                <div class="meta-item">
                    <dt>Dimensions</dt>
                    <dd>{{ tablet.width }}&times;{{ tablet.height }}&times;{{ tablet.thickness or '?' }} mm</dd>
                </div>
                {% endif %}
                {# Full attribution breakdown #}
                {% if has_attribution %}
                {% if tablet.atf_source %}
                <div class="meta-item">
                    <dt>Transliteration</dt>
                    <dd>{{ tablet.atf_source }}</dd>
                </div>
                {% endif %}
                {% if tablet.translation_source %}
                <div class="meta-item">
                    <dt>Translation</dt>
                    <dd>{{ tablet.translation_source }}</dd>
                </div>
                {% endif %}
                {% if tablet.publication_author %}
                <div class="meta-item">
                    <dt>Publication</dt>
                    <dd>{{ tablet.publication_author }}</dd>
                </div>
                {% endif %}
                {% endif %}
                {# ORACC per-project credits #}
                {% if has_oracc_credits %}
                {% for credit in tablet.oracc_credits %}
                <div class="meta-item meta-item--wide">
                    <dt>ORACC/{{ credit.oracc_project }}</dt>
                    <dd class="meta-item__credits">{{ credit.credits_text }}</dd>
                </div>
                {% endfor %}
                {% endif %}
            </dl>
            {% endif %}
    </div>
</header>

<div class="tablet-detail-viewer"
     data-viewer-state="expanded"
     data-p-number="{{ tablet.p_number }}">

        <div class="viewer-panel">
            <section class="tablet-image">
                <div class="zoombox" id="tablet-zoombox"
                     data-p-number="{{ tablet.p_number }}"
                     data-api-url="{{ api_url }}">

                    <div class="zoombox__viewport">
                        <div class="zoombox__transform">
                            <img class="zoombox__image is-loading" src="" alt="{{ tablet.designation or tablet.p_number }}">
                            <div class="zoombox__overlays"></div>
                        </div>
                        <div class="zoombox__loading">Loading image...</div>
                        <div class="zoombox__placeholder">
                            <span class="zoombox__placeholder-icon">&#x12000;</span>
                            <span>No image available</span>
                        </div>
                    </div>

                    <div class="zoombox__controls">
                        <button class="zoombox__btn" data-action="zoom-out" title="Zoom out (-)">&#x2212;</button>
                        <button class="zoombox__btn" data-action="zoom-in" title="Zoom in (+)">+</button>
                        <button class="zoombox__btn zoombox__btn--reset" data-action="reset" title="Reset (0)">&#x21BA;</button>
                    </div>

                    <div class="zoombox__minimap-container">
                        <div class="zoombox__minimap">
                            <canvas class="zoombox__minimap-canvas"></canvas>
                            <div class="zoombox__minimap-viewport"></div>
                        </div>
                    </div>
                </div>

                <div class="image-controls">
                    <p class="image-source" id="image-source"></p>
                </div>
            </section>
        </div>

        <div class="atf-panel" data-language="{{ tablet.language or '' }}"></div>

        <aside class="atf-knowledge-sidebar" id="knowledge-sidebar" data-state="closed">
            <!-- Vertical Icon Bar -->
            <nav class="tabs-nav tabs-nav--vertical-icons" role="tablist" aria-label="Knowledge panels">
                <button class="tab-button" data-tab="dictionary" role="tab" aria-selected="false" title="Dictionary">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M17.5 14.33C15.8 14.33 14.26 14.62 13 15.16V16.82C14.13 16.18 15.7 15.83 17.5 15.83C18.38 15.83 19.23 15.92 20 16.09V14.57C19.21 14.41 18.36 14.33 17.5 14.33Z"/>
                        <path d="M13 12.49V14.15C14.13 13.51 15.7 13.16 17.5 13.16C18.38 13.16 19.23 13.25 20 13.42V11.9C19.21 11.75 18.36 11.66 17.5 11.66C15.8 11.66 14.26 11.96 13 12.49Z"/>
                        <path d="M17.5 10.5C18.38 10.5 19.23 10.59 20 10.76V9.24C19.21 9.09 18.36 9 17.5 9C15.8 9 14.26 9.29 13 9.83V11.49C14.13 10.85 15.7 10.5 17.5 10.5Z"/>
                        <path d="M21 5C19.89 4.65 18.67 4.5 17.5 4.5C15.55 4.5 13.45 4.9 12 6C10.55 4.9 8.45 4.5 6.5 4.5C4.55 4.5 2.45 4.9 1 6V21.5C2.45 20.4 4.55 20 6.5 20C8.45 20 10.55 20.4 12 21.5C13.45 20.4 15.55 20 17.5 20C18.67 20 19.89 20.15 21 20.5C21.75 20.75 22.4 21.05 23 21.5V6C22.4 5.55 21.75 5.25 21 5ZM21 18.5C19.9 18.15 18.7 18 17.5 18C15.8 18 13.35 18.65 12 19.5V8C13.35 7.15 15.8 6.5 17.5 6.5C18.7 6.5 19.9 6.65 21 7V18.5Z"/>
                    </svg>
                </button>
                <button class="tab-button" data-tab="research" role="tab" aria-selected="false" title="Research">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M5 13.18V17.18L12 21L19 17.18V13.18L12 17L5 13.18ZM12 3L1 9L12 15L21 10.09V17H23V9L12 3Z"/>
                    </svg>
                </button>
                <button class="tab-button" data-tab="discussion" role="tab" aria-selected="false" title="Discussion">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M22 2H2.01L2 22L6 18H22V2ZM6 9H18V11H6V9ZM14 14H6V12H14V14ZM18 8H6V6H18V8Z"/>
                    </svg>
                </button>
                <button class="tab-button" data-tab="context" role="tab" aria-selected="false" title="Context">
                    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12C2 17.52 6.47 22 11.99 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 11.99 2ZM18.92 8H15.97C15.65 6.75 15.19 5.55 14.59 4.44C16.43 5.07 17.96 6.35 18.92 8ZM12 4.04C12.83 5.24 13.48 6.57 13.91 8H10.09C10.52 6.57 11.17 5.24 12 4.04ZM4.26 14C4.1 13.36 4 12.69 4 12C4 11.31 4.1 10.64 4.26 10H7.64C7.56 10.66 7.5 11.32 7.5 12C7.5 12.68 7.56 13.34 7.64 14H4.26ZM5.08 16H8.03C8.35 17.25 8.81 18.45 9.41 19.56C7.57 18.93 6.04 17.66 5.08 16ZM8.03 8H5.08C6.04 6.34 7.57 5.07 9.41 4.44C8.81 5.55 8.35 6.75 8.03 8ZM12 19.96C11.17 18.76 10.52 17.43 10.09 16H13.91C13.48 17.43 12.83 18.76 12 19.96ZM14.34 14H9.66C9.57 13.34 9.5 12.68 9.5 12C9.5 11.32 9.57 10.65 9.66 10H14.34C14.43 10.65 14.5 11.32 14.5 12C14.5 12.68 14.43 13.34 14.34 14ZM14.59 19.56C15.19 18.45 15.65 17.25 15.97 16H18.92C17.96 17.65 16.43 18.93 14.59 19.56ZM16.36 14C16.44 13.34 16.5 12.68 16.5 12C16.5 11.32 16.44 10.66 16.36 10H19.74C19.9 10.64 20 11.31 20 12C20 12.69 19.9 13.36 19.74 14H16.36Z"/>
                    </svg>
                </button>
            </nav>
            <!-- Sliding Content Panel -->
            <div class="knowledge-content-panel">
                <div class="knowledge-content-panel__header">
                    <span class="knowledge-content-panel__title">Dictionary</span>
                </div>
                <div class="knowledge-content-panel__body">
                <!-- Dictionary Tab Content -->
                <div class="knowledge-tab-content knowledge-tab-content--active" data-content="dictionary">
                    <!-- Browse Mode UI -->
                    <div class="knowledge-sidebar-dictionary">
                        <!-- Search & Filters -->
                        <div class="knowledge-sidebar-filters">
                            <div class="knowledge-sidebar-search">
                                <input type="text" class="knowledge-sidebar-search__input" placeholder="Search dictionary..." aria-label="Search dictionary">
                                <button class="knowledge-sidebar-search__clear is-hidden" aria-label="Clear search">&times;</button>
                            </div>
                            <select class="knowledge-sidebar-filter" data-filter="language" aria-label="Filter by language">
                                <option value="">All Languages</option>
                                <option value="akk">Akkadian (11,357)</option>
                                <option value="sux">Sumerian (5,271)</option>
                                <option value="qpn">Personal Names (4,039)</option>
                                <option value="sux-x-emesal">Emesal (146)</option>
                                <option value="xhu">Hurrian (137)</option>
                                <option value="uga">Ugaritic (100)</option>
                            </select>
                            <select class="knowledge-sidebar-filter" data-filter="pos" aria-label="Filter by part of speech">
                                <option value="">All Parts of Speech</option>
                                <optgroup label="Words">
                                    <option value="N">Noun</option>
                                    <option value="V">Verb</option>
                                    <option value="AJ">Adjective</option>
                                    <option value="AV">Adverb</option>
                                    <option value="NU">Number</option>
                                </optgroup>
                                <optgroup label="Pronouns">
                                    <option value="DP">Demonstrative</option>
                                    <option value="IP">Independent</option>
                                    <option value="PP">Personal</option>
                                    <option value="RP">Relative</option>
                                    <option value="XP">Indefinite</option>
                                    <option value="QP">Interrogative</option>
                                </optgroup>
                                <optgroup label="Function Words">
                                    <option value="CNJ">Conjunction</option>
                                    <option value="PRP">Preposition</option>
                                    <option value="DET">Determiner</option>
                                    <option value="MOD">Modal</option>
                                    <option value="REL">Relative</option>
                                </optgroup>
                                <optgroup label="Proper Names">
                                    <option value="DN">Divine Name</option>
                                    <option value="PN">Personal Name</option>
                                    <option value="RN">Royal Name</option>
                                    <option value="GN">Geographic Name</option>
                                    <option value="TN">Temple Name</option>
                                    <option value="WN">Watercourse Name</option>
                                    <option value="FN">Field Name</option>
                                    <option value="MN">Month Name</option>
                                    <option value="ON">Object Name</option>
                                    <option value="AN">Agricultural Name</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Active Filter Chips -->
                        <div class="knowledge-sidebar-filter-chips is-hidden"></div>

                        <!-- Results List -->
                        <div class="knowledge-sidebar-list">
                            <div class="knowledge-sidebar-list__items"></div>
                            <div class="knowledge-sidebar-list__footer is-hidden">
                                <span class="knowledge-sidebar-list__count"></span>
                                <button class="btn btn-sm knowledge-sidebar-list__load-more is-hidden">Load more</button>
                            </div>
                        </div>
                    </div>

                    <!-- Word Detail UI (for word clicks) -->
                    <div class="knowledge-sidebar-word-detail is-hidden">
                        <div class="knowledge-sidebar-word-header">
                            <button class="knowledge-sidebar-word-header__back" aria-label="Back to browse">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                                </svg>
                                <span class="knowledge-sidebar-word-header__citation"></span>
                            </button>
                        </div>
                        <div class="knowledge-sidebar-word-content"></div>
                    </div>
                </div>
                <!-- Research Tab Content -->
                <div class="knowledge-tab-content" data-content="research">
                    <div class="knowledge-sidebar-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M5 13.18V17.18L12 21L19 17.18V13.18L12 17L5 13.18ZM12 3L1 9L12 15L21 10.09V17H23V9L12 3Z"/>
                        </svg>
                        <h3>Research Notes</h3>
                        <p>Cross-references, parallel texts, and scholarly notes will appear here.</p>
                    </div>
                </div>
                <!-- Discussion Tab Content -->
                <div class="knowledge-tab-content" data-content="discussion">
                    <div class="knowledge-sidebar-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M22 2H2.01L2 22L6 18H22V2ZM6 9H18V11H6V9ZM14 14H6V12H14V14ZM18 8H6V6H18V8Z"/>
                        </svg>
                        <h3>Discussion</h3>
                        <p>Community interpretations and scholarly discussions will appear here.</p>
                    </div>
                </div>
                <!-- Context Tab Content -->
                <div class="knowledge-tab-content" data-content="context">
                    <div class="knowledge-sidebar-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M11.99 2C6.47 2 2 6.48 2 12C2 17.52 6.47 22 11.99 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 11.99 2ZM18.92 8H15.97C15.65 6.75 15.19 5.55 14.59 4.44C16.43 5.07 17.96 6.35 18.92 8ZM12 4.04C12.83 5.24 13.48 6.57 13.91 8H10.09C10.52 6.57 11.17 5.24 12 4.04ZM4.26 14C4.1 13.36 4 12.69 4 12C4 11.31 4.1 10.64 4.26 10H7.64C7.56 10.66 7.5 11.32 7.5 12C7.5 12.68 7.56 13.34 7.64 14H4.26ZM5.08 16H8.03C8.35 17.25 8.81 18.45 9.41 19.56C7.57 18.93 6.04 17.66 5.08 16ZM8.03 8H5.08C6.04 6.34 7.57 5.07 9.41 4.44C8.81 5.55 8.35 6.75 8.03 8ZM12 19.96C11.17 18.76 10.52 17.43 10.09 16H13.91C13.48 17.43 12.83 18.76 12 19.96ZM14.34 14H9.66C9.57 13.34 9.5 12.68 9.5 12C9.5 11.32 9.57 10.65 9.66 10H14.34C14.43 10.65 14.5 11.32 14.5 12C14.5 12.68 14.43 13.34 14.34 14ZM14.59 19.56C15.19 18.45 15.65 17.25 15.97 16H18.92C17.96 17.65 16.43 18.93 14.59 19.56ZM16.36 14C16.44 13.34 16.5 12.68 16.5 12C16.5 11.32 16.44 10.66 16.36 10H19.74C19.9 10.64 20 11.31 20 12C20 12.69 19.9 13.36 19.74 14H16.36Z"/>
                        </svg>
                        <h3>Historical Context</h3>
                        <p>Period information, archaeological context, and related materials will appear here.</p>
                    </div>
                </div>
                </div>
            </div>
        </aside>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/zoombox.js"></script>
<script src="/static/js/atf-viewer.js"></script>
<script src="/static/js/atf-viewer-integration.js"></script>
<script src="/static/js/tablet-detail.js"></script>
{% if debug_tablets_json %}
<script>
(function() {
    var tablets = JSON.parse({{ debug_tablets_json | tojson }});
    var base = {{ web_url | tojson }};
    console.groupCollapsed('[Glintstone Debug] Test tablets (' + tablets.length + ')');
    tablets.forEach(function(t) {
        console.log(base + '/tablets/' + t.p + '  %c' + t.note, 'color: gray');
    });
    console.groupEnd();
})();
</script>
{% endif %}
{% if debug_json %}
<script>
console.groupCollapsed('[Glintstone Debug] {{ tablet.p_number }} — all known data');
console.log(JSON.parse({{ debug_json | tojson }}));
console.groupEnd();
</script>
{% endif %}
{% endblock %}
