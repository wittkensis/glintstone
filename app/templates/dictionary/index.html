{% extends "base.html" %}
{% from "components/_macros.html" import dictionary_filter_sidebar, pagination %}

{% block title %}Dictionary - Glintstone{% endblock %}

{% block content %}
<main class="dictionary-page">
    <div class="dict-layout" data-api-url="{{ api_url }}">
        {# Filter sidebar #}
        {{ dictionary_filter_sidebar(
            level=level,
            search_value=search or '',
            language=language or [],
            pos=pos or [],
            source=source or [],
            frequency=frequency or '',
            filter_options=filter_options,
            sort=sort or ''
        ) }}

        {# Main content: results + detail panel #}
        <div class="dict-main">
            <div class="page-header">
                <div class="page-header-main">
                    <div class="page-header-title">
                        <h1>Dictionary</h1>
                        <p class="subtitle">{{ '{:,}'.format(total) }}
                            {% if level == 'signs' %}signs{% elif level == 'glosses' %}gloss groups{% else %}lemmas{% endif %}
                        </p>
                    </div>
                </div>
            </div>

            {# Level switcher #}
            {% set fq = namespace(s='') %}
            {% if search %}{% set fq.s = fq.s ~ 'search=' ~ (search|urlencode) ~ '&' %}{% endif %}
            {% for l in language %}{% set fq.s = fq.s ~ 'language=' ~ (l|urlencode) ~ '&' %}{% endfor %}
            {% for p in pos %}{% set fq.s = fq.s ~ 'pos=' ~ (p|urlencode) ~ '&' %}{% endfor %}
            {% for s in source %}{% set fq.s = fq.s ~ 'source=' ~ (s|urlencode) ~ '&' %}{% endfor %}
            {% if frequency %}{% set fq.s = fq.s ~ 'frequency=' ~ (frequency|urlencode) ~ '&' %}{% endif %}

            <div class="dict-level-bar">
                <nav class="btn-group" role="tablist">
                    <a href="/dictionary?{{ fq.s }}level=signs"
                       class="btn btn--sm{% if level == 'signs' %} btn--active{% endif %}"
                       role="tab" aria-selected="{{ 'true' if level == 'signs' else 'false' }}">Signs</a>
                    <a href="/dictionary?{{ fq.s }}level=lemmas"
                       class="btn btn--sm{% if level == 'lemmas' %} btn--active{% endif %}"
                       role="tab" aria-selected="{{ 'true' if level == 'lemmas' else 'false' }}">Lemmas</a>
                    <a href="/dictionary?{{ fq.s }}level=glosses"
                       class="btn btn--sm{% if level == 'glosses' %} btn--active{% endif %}"
                       role="tab" aria-selected="{{ 'true' if level == 'glosses' else 'false' }}">Glosses</a>
                </nav>
                <div class="dict-sort">
                    <label class="dict-sort__label" for="dict-sort-select">Sort:</label>
                    <select id="dict-sort-select" class="dict-sort__select">
                        {% if level == 'signs' %}
                        <option value="name" {% if sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                        <option value="lemmas" {% if sort == 'lemmas' %}selected{% endif %}>Linked Lemmas</option>
                        {% elif level == 'glosses' %}
                        <option value="attestations" {% if sort != 'alpha' %}selected{% endif %}>Attestations</option>
                        <option value="alpha" {% if sort == 'alpha' %}selected{% endif %}>Alphabetical</option>
                        {% else %}
                        <option value="frequency" {% if sort != 'alpha' %}selected{% endif %}>Frequency</option>
                        <option value="alpha" {% if sort == 'alpha' %}selected{% endif %}>Alphabetical</option>
                        {% endif %}
                    </select>
                </div>
            </div>

            {# Active filter pills #}
            {% if active_filters %}
            <div class="active-filters">
                <div class="active-filters__pills">
                    {% for f in active_filters %}
                    <a href="{{ f.remove_url }}" class="filter-pill">
                        <span class="filter-pill__label">{{ f.label }}</span>
                        <span class="filter-pill__remove" aria-label="Remove">&times;</span>
                    </a>
                    {% endfor %}
                </div>
                <a href="/dictionary?level={{ level }}" class="active-filters__clear">Clear all</a>
            </div>
            {% endif %}

            {# Results + Detail split #}
            <div class="dict-content">
                {# Result list #}
                <div class="dict-results" id="dict-results">
                    {% if items %}
                        {% for item in items %}

                            {# ── SIGN CARD ── #}
                            {% if level == 'signs' %}
                            <button class="dict-card dict-card--sign" data-id="{{ item.id }}" data-level="signs">
                                <div class="dict-card__header">
                                    {% if item.unicode_char %}
                                    <span class="dict-card__glyph">{{ item.unicode_char }}</span>
                                    {% endif %}
                                    <span class="dict-card__title">{{ item.sign_name }}</span>
                                </div>
                                <div class="dict-card__stats">
                                    {{ item.reading_count or 0 }} readings
                                    &middot; {{ item.lemma_count or 0 }} lemmas
                                </div>
                                {% if item.glosses %}
                                <div class="dict-card__glosses">{{ item.glosses[:6]|join(', ') }}{% if item.glosses|length > 6 %}&hellip;{% endif %}</div>
                                {% endif %}
                                <div class="dict-card__meta">{{ item.source_label }}</div>
                            </button>

                            {# ── LEMMA CARD ── #}
                            {% elif level == 'lemmas' %}
                            <button class="dict-card dict-card--lemma" data-id="{{ item.id }}" data-level="lemmas">
                                <div class="dict-card__header">
                                    <span class="dict-card__title">{{ item.citation_form }}
                                        {% if item.guide_word %}<span class="dict-card__guide">[{{ item.guide_word }}]</span>{% endif %}
                                    </span>
                                    {% if item.pos_label %}
                                    <span class="dict-card__badge">{{ item.pos_label }}</span>
                                    {% endif %}
                                </div>
                                <div class="dict-card__meta">{{ item.language_label }} &middot; {{ item.source_label }}</div>
                                {% if item.glosses %}
                                <div class="dict-card__glosses">{{ item.glosses[:6]|join(', ') }}{% if item.glosses|length > 6 %}&hellip;{% endif %}</div>
                                {% endif %}
                                <div class="dict-card__stats">{{ '{:,}'.format(item.attestation_count or 0) }} attestations</div>
                            </button>

                            {# ── GLOSS CARD ── #}
                            {% elif level == 'glosses' %}
                            <button class="dict-card dict-card--gloss" data-id="{{ item.guide_word }}" data-level="glosses" data-pos="{{ item.pos or '' }}">
                                <div class="dict-card__header">
                                    <span class="dict-card__title">&ldquo;{{ item.guide_word }}&rdquo;</span>
                                    {% if item.pos_label %}
                                    <span class="dict-card__badge">{{ item.pos_label }}</span>
                                    {% endif %}
                                </div>
                                <div class="dict-card__stats">
                                    {{ item.lemma_count }} lemma{{ 's' if item.lemma_count != 1 }}
                                    across {{ item.language_count }} language{{ 's' if item.language_count != 1 }}
                                </div>
                                {% if item.lemmas_grouped %}
                                <div class="dict-card__langs">
                                    {% for lang_name, cfs in item.lemmas_grouped.items() %}
                                    <span class="dict-card__lang-group">
                                        <span class="dict-card__lang-name">{{ lang_name }}:</span>
                                        {{ cfs[:4]|join(', ') }}{% if cfs|length > 4 %}&hellip;{% endif %}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="dict-card__stats">{{ '{:,}'.format(item.total_attestations or 0) }} total attestations</div>
                            </button>
                            {% endif %}

                        {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">&#x12000;</div>
                        <h3>No results found</h3>
                        <p>Try adjusting your search or filters.</p>
                    </div>
                    {% endif %}
                </div>

                {# Detail panel #}
                <div class="dict-detail" id="dict-detail">
                    <div class="dict-detail__placeholder">
                        <h3>Select an entry</h3>
                        <p>Click a result to view its details</p>
                    </div>
                </div>
            </div>

            {# Pagination #}
            {% set base = '/dictionary?' ~ fq.s ~ 'level=' ~ level ~ '&sort=' ~ sort ~ '&' %}
            {{ pagination(page, total_pages, base) }}
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var sortSelect = document.getElementById('dict-sort-select');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            var url = new URL(window.location.href);
            url.searchParams.set('sort', this.value);
            url.searchParams.delete('page');
            window.location.href = url.href;
        });
    }
})();
</script>
<script src="/static/js/dictionary-browser.js"></script>
{% endblock %}
