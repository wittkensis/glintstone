<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Glintstone Schema Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <style>
    body { background: #0f1117; color: #c9d1d9; font-family: 'Inter', system-ui, sans-serif; }
    .tab-btn { transition: all 0.15s; }
    .tab-btn.active { background: #1c2030; color: #e2e8f0; border-bottom: 2px solid #8b7355; }
    .tab-btn:not(.active):hover { background: #161922; }
    .diagram-panel { display: none; }
    .diagram-panel.active { display: block; }
    .mermaid { display: flex; justify-content: center; padding: 2rem 0.5rem; }
    .mermaid svg { max-width: 100%; height: auto; }
    .legend { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: #9ca3af; }
    .legend-swatch { width: 14px; height: 14px; border-radius: 3px; border: 1.5px solid; }
  </style>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
</head>
<body class="min-h-screen">

  <header class="border-b border-gray-800 px-6 py-4">
    <h1 class="text-lg font-semibold text-gray-200 tracking-tight">Glintstone Schema Explorer</h1>
    <p class="text-sm text-gray-500 mt-1">v2 schema architecture &mdash; sources, layers, and linguistic systems</p>
  </header>

  <nav class="flex border-b border-gray-800 px-4 gap-1 overflow-x-auto" id="tabs">
    <button class="tab-btn active px-4 py-3 text-sm text-gray-400 whitespace-nowrap" data-tab="sources-v2">1. Sources &rarr; v2 Tables</button>
    <button class="tab-btn px-4 py-3 text-sm text-gray-400 whitespace-nowrap" data-tab="tablet-journey">2. Tablet Layer Journey</button>
    <button class="tab-btn px-4 py-3 text-sm text-gray-400 whitespace-nowrap" data-tab="linguistic-chain">3. Linguistic Chain</button>
  </nav>

  <main class="p-6 max-w-[1400px] mx-auto">

    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- TAB 1: Sources → v2 Tables (Complete Import Pipeline)  -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <div class="diagram-panel active" id="panel-sources-v2">
      <div class="mb-4">
        <h2 class="text-sm font-medium text-gray-300">Complete Import Pipeline: All Sources &rarr; v2 Tables</h2>
        <p class="text-xs text-gray-500 mt-1">Every source file and which v2 database table(s) it populates. Solid = active. Dashed = blocked or future. Grouped by v2 layer.</p>
        <div class="legend mt-3">
          <div class="legend-item"><span class="legend-swatch" style="background:#2d5a3d;border-color:#4ade80;"></span> Token hub (central entity)</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#1e3a4a;border-color:#38bdf8;"></span> New in v2</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#1c2030;border-color:#6b7280;"></span> Carried/expanded from v1</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#4a1c1c;border-color:#f87171;"></span> Blocked</div>
        </div>
      </div>
      <pre class="mermaid">
flowchart LR
  subgraph CDLI["CDLI"]
    C_CAT["Catalog\n353k rows\n64 cols CSV"]
    C_ATF["ATF\n135k texts\n3.5M lines"]
    C_API["API\nsample only"]
  end

  subgraph ORACC["ORACC"]
    O_CAT["Catalogue\n~10 projects"]
    O_CORP["Corpus\n~7.5k texts\nCDL+GDL JSON"]
    O_GLOSS["Glossary\ndcclt+epsd2+saao"]
    O_GEO["GeoJSON\n6 projects"]
  end

  subgraph SignsML["Signs + ML"]
    OGSL["OGSL\n3,367 signs"]
    COMPVIS["CompVis\n81 tablets\n8,109 bboxes"]
    EBL["eBL\n173 classes"]
    EPSD2["ePSD2\nUnicode+CAD"]
  end

  subgraph Future["Future"]
    BABYLEM["BabyLemmatizer"]
    ML_OCR["ML OCR Models"]
  end

  subgraph L0["Layer 0: Identity"]
    artifacts["artifacts\n~40 cols"]
    composites["composites"]
    art_comp["artifact_composites"]
    exc_sites["excavation_sites"]
  end

  subgraph L1["Layer 1: Physical"]
    surfaces["surfaces"]
    sign_ann["sign_annotations"]
  end

  subgraph L2["Layer 2: Graphemic"]
    signs["signs\n+mzl +abz +lak"]
    sign_vals["sign_values\n+context"]
    sign_var["sign_variants"]
  end

  subgraph L3["Layer 3: Reading"]
    text_lines["text_lines"]
    tokens["tokens"]
  end

  subgraph L4["Layer 4: Linguistic"]
    lemmat["lemmatizations\nmultiple per token"]
    morph["morphology\nlang-polymorphic"]
    transl["translations\n+line alignment"]
  end

  subgraph L5["Layer 5: Semantic"]
    gl_e["glossary_entries"]
    gl_f["glossary_forms"]
    gl_s["glossary_senses"]
    intertext["intertextuality_links"]
  end

  subgraph Infra["Infrastructure"]
    ann_runs["annotation_runs\nprovenance for all"]
    pipeline["pipeline_status\nper-layer 0.0-1.0"]
  end

  C_CAT -->|"P-number, museum_no\nperiod, provenience\ngenre, material\n(16 of 64 cols in v1)"| artifacts
  C_ATF -->|"@surface markers"| surfaces
  C_ATF -->|"line-by-line\ndecomposition"| text_lines
  C_ATF -->|"basic tokenization\n(no lemma)"| tokens
  C_ATF -->|"#tr.en: #tr.de:"| transl
  C_ATF -->|">>Q refs"| composites
  C_API -.->|"publications\ncollections\nlow priority"| artifacts

  O_CAT -->|"pleiades_id\nsubgenre, languages\nsupergenre"| artifacts
  O_CORP -->|"CDL tree nodes\nform, GDL, lang\ndamage, reading"| tokens
  O_CORP -->|"CDL structure"| text_lines
  O_CORP -->|"lemma.f:\ncf/gw/pos/sense\nnorm/base/sig"| lemmat
  O_CORP -->|"morph string\nparsed to slots"| morph
  O_CORP -->|"1 run per project"| ann_runs
  O_GLOSS -->|"headwords + icount\nperiods, norms"| gl_e
  O_GLOSS -->|"attested forms"| gl_f
  O_GLOSS -->|"sense hierarchy\n+ signatures"| gl_s
  O_GEO -->|"lat/lon\npleiades IDs"| artifacts
  O_GEO -->|"site coords"| exc_sites

  OGSL -->|"sign inventory\nGDL definitions\nutf8, hex, uname"| signs
  OGSL -->|"all readings\nper sign"| sign_vals
  OGSL -->|"gunu, tenu\nsheshig, etc."| sign_var
  COMPVIS -->|"bboxes as %\nMZL → sign_id\nvia concordance"| sign_ann
  COMPVIS -->|"tablet surfaces"| surfaces
  COMPVIS -->|"ML model run"| ann_runs
  EBL -.->|"BLOCKED\nneeds concordance\nABZ → OGSL"| sign_ann
  EBL -.->|"partial\nABZ→Unicode\n173 classes"| signs
  EPSD2 -.->|"Unicode ref"| signs

  BABYLEM -.->|"competing\nlemmatizations"| lemmat
  BABYLEM -.->|"model run"| ann_runs
  ML_OCR -.->|"automated\ndetection"| sign_ann
  ML_OCR -.->|"model run"| ann_runs

  style tokens fill:#2d5a3d,stroke:#4ade80,color:#fff
  style surfaces fill:#1e3a4a,stroke:#38bdf8,color:#ccc
  style text_lines fill:#1e3a4a,stroke:#38bdf8,color:#ccc
  style lemmat fill:#1e3a4a,stroke:#38bdf8,color:#ccc
  style morph fill:#1e3a4a,stroke:#38bdf8,color:#ccc
  style sign_var fill:#1e3a4a,stroke:#38bdf8,color:#ccc
  style intertext fill:#1e3a4a,stroke:#38bdf8,color:#ccc
  style ann_runs fill:#1e3a4a,stroke:#38bdf8,color:#ccc
  style EBL fill:#4a1c1c,stroke:#f87171,color:#fca5a5
  style BABYLEM fill:#1a1a2e,stroke:#6366f1,color:#a5b4fc
  style ML_OCR fill:#1a1a2e,stroke:#6366f1,color:#a5b4fc
  style C_API fill:#1c1c1c,stroke:#555,color:#888
      </pre>
    </div>

    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- TAB 2: Tablet Layer Journey                            -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <div class="diagram-panel" id="panel-tablet-journey">
      <div class="mb-4">
        <h2 class="text-sm font-medium text-gray-300">Tablet Layer Journey: Identity &rarr; Physical &rarr; Graphemic &rarr; Reading &rarr; Linguistic &rarr; Semantic</h2>
        <p class="text-xs text-gray-500 mt-1">Follow a single tablet as its data is progressively enriched at each layer. Left column = sources feeding that layer. Center = v2 tables and key fields. Right = what gets answered.</p>
        <div class="legend mt-3">
          <div class="legend-item"><span class="legend-swatch" style="background:#2a1a3a;border-color:#a78bfa;"></span> Source input</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#1c2030;border-color:#8b7355;"></span> v2 table + key fields</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#2d5a3d;border-color:#4ade80;"></span> Token hub</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#3a2a1a;border-color:#d97706;"></span> Coverage limitation</div>
        </div>
      </div>
      <pre class="mermaid">
flowchart TB
  subgraph L0["LAYER 0 — IDENTITY: What is this artifact?"]
    direction LR
    S0["CDLI Catalog\nORACC Catalogue\nORACC GeoJSON"]
    T0["artifacts\n─────────────────\np_number, museum_no\nperiod_normalized\nprovenience_normalized\ngenre, subgenre, supergenre\nlanguage, languages\nlat, lon, pleiades_id\nmaterial, object_type\ncollection, primary_publication"]
    T0b["composites\n─────────────────\nq_number\ndesignation\nexemplar_count"]
    Q0["What is this tablet?\nWhere was it found?\nWhat period? What genre?"]
    S0 --> T0
    S0 --> T0b
    T0 --- Q0
  end

  subgraph L1["LAYER 1 — PHYSICAL: What does the artifact look like?"]
    direction LR
    S1["CompVis bboxes\neBL bboxes (future)\nCDLI ATF @markers"]
    T1a["surfaces\n─────────────────\nsurface_type:\n  obverse, reverse\n  left/right/top/bottom\n  seal\nimage_path, dimensions"]
    T1b["sign_annotations\n─────────────────\nsurface_id → surfaces\nsign_id → signs (resolved)\nbbox: x%, y%, w%, h%\nline_number, position\ndamage_status:\n  intact|damaged|missing\nannotation_run_id\nconfidence"]
    Q1["Where are signs located?\nWhat is damaged?\nWhich surface?"]
    S1 --> T1a
    S1 --> T1b
    T1a --- Q1
  end

  subgraph L2["LAYER 2 — GRAPHEMIC: What signs are present?"]
    direction LR
    S2["OGSL Sign List\nePSD2 Unicode ref\neBL partial concordance"]
    T2a["signs\n─────────────────\nsign_id (OGSL canonical)\nutf8, unicode_hex\nmzl_number (CompVis key)\nabz_number (eBL key)\nlak_number\ngdl_definition (JSON)\ntotal_corpus_frequency"]
    T2b["sign_values\n─────────────────\nvalue, sub_index\nvalue_type:\n  logographic|syllabic\n  determinative|numeric\nlanguage_context\nperiod_context\nfrequency"]
    T2c["sign_variants\n─────────────────\nbase_sign → signs\nmodifier: gunu, tenu\nsheshig, nutillu"]
    Q2["Which signs appear?\nWhat are their readings?\nHow do sign IDs map?"]
    S2 --> T2a
    S2 --> T2b
    S2 --> T2c
    T2a --- Q2
  end

  subgraph L3["LAYER 3 — READING: How is the text read?"]
    direction LR
    S3["CDLI ATF (135k texts)\nORACC Corpus (~7.5k)"]
    T3a["text_lines\n─────────────────\nsurface_id → surfaces\nline_number\nraw_atf\nis_ruling, is_blank\nsource: cdli|oracc"]
    T3b["tokens\n─────────────────\nline_id → text_lines\nposition (in line)\nform (transliterated)\nreading\nsign_function:\n  logo|syllabo|det|num\nlang (per-token!)\ngdl_json (sign tree)\ndamage, confidence"]
    Q3["What does the text say?\nHow are signs read?\nWhat language per word?"]
    S3 --> T3a
    S3 --> T3b
    T3a --- Q3
  end

  subgraph L4["LAYER 4 — LINGUISTIC: What do the words mean?"]
    direction LR
    S4["ORACC Corpus only\n~7.5k texts = 5.5%\n(+ BabyLemmatizer future)"]
    T4a["lemmatizations\n─────────────────\ntoken_id → tokens\ncitation_form, guide_word\nsense, pos, epos\nnorm, base\nmorph_raw, signature\nis_consensus\nannotation_run_id\nconfidence\n(MULTIPLE per token)"]
    T4b["morphology\n─────────────────\nlemmatization_id\nlanguage_family\n\nAkkadian slots:\n  root, stem (G/D/S/N)\n  tense, person, number\n  gender, case, state\n\nSumerian slots:\n  conjugation_prefix\n  dimensional_prefixes\n  stem_form, aspect\n  pronominal_suffix"]
    Q4["What word is this?\nWhat does it mean?\nWhat is its grammar?"]
    S4 --> T4a
    S4 --> T4b
    T4a --- Q4
  end

  subgraph L5["LAYER 5 — SEMANTIC: What is the meaning?"]
    direction LR
    S5["ORACC Glossary\nCDLI ATF translations\nEditorial work (future)"]
    T5a["translations\n─────────────────\np_number → artifacts\nline_id → text_lines\nlanguage: en, de, ...\nsource, annotation_run_id"]
    T5b["glossary_entries\n─────────────────\ncitation_form, guide_word\npos, language, icount\nperiods, norms\n→ glossary_forms\n→ glossary_senses"]
    T5c["intertextuality_links\n─────────────────\nsource tokens → target tokens\nlink_type:\n  parallel|quotation\n  formula|duplicate\nconfidence"]
    Q5["What does the text say\nin English/German?\nWhat parallels exist?"]
    S5 --> T5a
    S5 --> T5b
    S5 --> T5c
    T5a --- Q5
  end

  subgraph PROV["CROSS-CUTTING — Who analyzed this?"]
    direction LR
    SP["All sources generate\nannotation_runs\non import"]
    TP["annotation_runs\n─────────────────\nsource_type:\n  human|model|hybrid|import\nsource_name:\n  ORACC/dcclt\n  BabyLemmatizer v2.2\n  CompVis DETR\nmodel_version\ncorpus_scope"]
    QP["Who produced this analysis?\nHuman or ML?\nWhich version?"]
    SP --> TP
    TP --- QP
  end

  L0 ==> L1
  L1 ==> L2
  L2 ==> L3
  L3 ==> L4
  L4 ==> L5

  style S0 fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style S1 fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style S2 fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style S3 fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style S4 fill:#3a2a1a,stroke:#d97706,color:#fbbf24
  style S5 fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style SP fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style T3b fill:#2d5a3d,stroke:#4ade80,color:#d1fae5
  style Q0 fill:#0f1117,stroke:#374151,color:#6b7280
  style Q1 fill:#0f1117,stroke:#374151,color:#6b7280
  style Q2 fill:#0f1117,stroke:#374151,color:#6b7280
  style Q3 fill:#0f1117,stroke:#374151,color:#6b7280
  style Q4 fill:#0f1117,stroke:#374151,color:#6b7280
  style Q5 fill:#0f1117,stroke:#374151,color:#6b7280
  style QP fill:#0f1117,stroke:#374151,color:#6b7280
      </pre>
    </div>

    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- TAB 3: Linguistic System Chain                         -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <div class="diagram-panel" id="panel-linguistic-chain">
      <div class="mb-4">
        <h2 class="text-sm font-medium text-gray-300">Linguistic System Chain: Tablets &rarr; Signs &rarr; Tokens &rarr; Meanings &rarr; Translations</h2>
        <p class="text-xs text-gray-500 mt-1">How cuneiform marks on clay become translated, analyzed text. Shows the full entity-relationship chain through the v2 schema. Numbers indicate cardinality.</p>
        <div class="legend mt-3">
          <div class="legend-item"><span class="legend-swatch" style="background:#2d5a3d;border-color:#4ade80;"></span> Token = central hub</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#1e3a4a;border-color:#38bdf8;"></span> Linguistic analysis branch</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#2a1a3a;border-color:#a78bfa;"></span> Sign identification branch</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#3a1a1a;border-color:#f87171;"></span> Concordance (must be built)</div>
        </div>
      </div>
      <pre class="mermaid">
flowchart TB
  art["artifact\n(P-number)\n353k records"]
  art -->|"1 artifact\nhas 2-7"| surf

  surf["surface\nobverse | reverse | edge\n(parsed from ATF @markers)"]
  surf -->|"1 surface\nhas 5-50"| line

  line["text_line\nraw ATF + line_number\n(from CDLI ATF or ORACC CDL)"]
  line -->|"1 line\nhas 3-15"| tok

  tok["TOKEN\nform + reading + lang\ngdl_json + sign_function\ndamage + confidence\n━━━━━━━━━━━━━━━━━\nCENTRAL HUB\neverything connects here"]

  %% ─── LEFT BRANCH: Physical / Sign identification ───
  tok -->|"token contains\n1-5 signs via GDL"| gdl

  gdl["GDL Sign Instances\n(JSON array on token)\neach: sign_name + reading\n+ operator: beside|above\n+ break markers"]
  gdl -->|"each GDL node\nreferences via OID"| ogsl_sign

  ogsl_sign["signs table\n(OGSL canonical)\nsign_id, utf8, unicode_hex\ngdl_definition"]
  ogsl_sign -->|"1 sign has\n1-20 readings"| sv

  sv["sign_values\nvalue + sub_index\ntype: logo|syllabic|det|num\nlanguage_context\nperiod_context\nfrequency"]

  ogsl_sign -->|"some signs have"| var
  var["sign_variants\ngunu (@g)\ntenu (@t)\nsheshig (@s)"]

  %% Sign concordance (the critical gap)
  ogsl_sign --- conc
  conc["CONCORDANCE\n(must be built)\n─────────────\nmzl_number ↔ sign_id\nabz_number ↔ sign_id\nNeeded to unify:\nCompVis MZL labels\neBL ABZ labels"]

  %% Physical annotation branch
  tok -->|"0-1 bbox\nper token"| ann

  ann["sign_annotation\nsurface_id → surface\nsign_id → signs (resolved)\nbbox: x%, y%, w%, h%\ndamage_status\nconfidence"]
  ann -->|"provenance"| run_phys
  run_phys["annotation_run\nCompVis DETR\nor eBL model\nor manual"]

  %% ─── RIGHT BRANCH: Linguistic analysis ───
  tok -->|"1 token has\n1+ competing"| lem

  lem["lemmatization\ncitation_form + guide_word\nsense + pos + epos\nnorm + base\nmorph_raw\nsignature (full ORACC sig)\nis_consensus flag\nconfidence"]

  lem -->|"provenance"| run_ling
  run_ling["annotation_run\nORACC/dcclt (human)\nORACC/epsd2 (human)\nBabyLemmatizer (ML)\netc."]

  lem -->|"1 lemmatization\nhas 0-1"| morph

  morph["morphology\nlanguage_family discriminator\n━━━━━━━━━━━━━━━━━\nAkkadian:\n  root (triconsonantal)\n  stem: G|D|Sh|N\n  tense, person, number\n  gender, case, state\n━━━━━━━━━━━━━━━━━\nSumerian:\n  conjugation_prefix\n  dimensional_prefixes\n  stem_form, aspect\n  pronominal_suffix\n  transitivity"]

  lem -->|"links to\ndictionary"| gl_e

  gl_e["glossary_entry\nheadword, cf, gw\npos, language\nicount, periods, norms"]
  gl_e -->|"1 entry has\nmany"| gl_f
  gl_e -->|"1 entry has\nhierarchical"| gl_s

  gl_f["glossary_forms\nattested spellings\ncount, norm, lang"]
  gl_s["glossary_senses\nsense_number\ndefinition, POS\nsignatures (attestations)"]

  %% ─── BOTTOM BRANCH: Translation + Intertextuality ───
  line -->|"1 line has\n0-1 per language"| trans

  trans["translation\nlanguage: en|de|...\nsource: cdli|oracc\nannotation_run_id"]

  tok -->|"token spans can\nlink across texts"| inter

  inter["intertextuality_link\nsource_tokens ↔ target_tokens\ntype: parallel|quotation\n  formula|duplicate\nconfidence"]

  %% ─── PROVENANCE (cross-cutting) ───
  lem -.-> run_ling
  ann -.-> run_phys

  style tok fill:#2d5a3d,stroke:#4ade80,color:#d1fae5
  style lem fill:#1e3a4a,stroke:#38bdf8,color:#bae6fd
  style morph fill:#1e3a4a,stroke:#38bdf8,color:#bae6fd
  style gl_e fill:#1e3a4a,stroke:#38bdf8,color:#bae6fd
  style gl_f fill:#1e3a4a,stroke:#38bdf8,color:#bae6fd
  style gl_s fill:#1e3a4a,stroke:#38bdf8,color:#bae6fd
  style ogsl_sign fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style sv fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style var fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style gdl fill:#2a1a3a,stroke:#a78bfa,color:#d4bfff
  style conc fill:#3a1a1a,stroke:#f87171,color:#fca5a5
  style run_phys fill:#1c1c2e,stroke:#6366f1,color:#a5b4fc
  style run_ling fill:#1c1c2e,stroke:#6366f1,color:#a5b4fc
  style inter fill:#2a2a1a,stroke:#eab308,color:#fde68a
  style trans fill:#2a2a1a,stroke:#eab308,color:#fde68a
      </pre>
    </div>

  </main>

  <footer class="border-t border-gray-800 px-6 py-3">
    <p class="text-xs text-gray-600">Glintstone Schema Explorer &middot; Based on schema-architecture/ YAML files &middot; v2 proposed design</p>
    <p class="text-xs text-gray-700 mt-1">Key coverage: 353k artifacts, 135k transliterated, ~7.5k lemmatized (5.5%), 3,367 signs, 8,109 bboxes</p>
  </footer>

  <script>
    mermaid.initialize({
      startOnLoad: false,
      theme: 'dark',
      themeVariables: {
        darkMode: true,
        background: '#0f1117',
        primaryColor: '#1c2030',
        primaryBorderColor: '#8b7355',
        primaryTextColor: '#c9d1d9',
        secondaryColor: '#1e3a4a',
        lineColor: '#4b5563',
        fontSize: '13px'
      },
      flowchart: {
        curve: 'basis',
        padding: 16,
        nodeSpacing: 30,
        rankSpacing: 40,
        htmlLabels: true
      }
    });

    const tabs = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.diagram-panel');

    tabs.forEach(tab => {
      tab.addEventListener('click', async () => {
        const target = tab.dataset.tab;
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        panels.forEach(p => p.classList.remove('active'));
        const panel = document.getElementById(`panel-${target}`);
        panel.classList.add('active');
        await renderPanel(panel);
      });
    });

    async function renderPanel(panel) {
      const el = panel.querySelector('.mermaid');
      if (el && !el.dataset.rendered) {
        const id = `mermaid-${Date.now()}`;
        try {
          const { svg } = await mermaid.render(id, el.textContent.trim());
          el.innerHTML = svg;
          el.dataset.rendered = 'true';
        } catch (err) {
          el.innerHTML = `<pre style="color:#f87171;padding:1rem;">Render error: ${err.message}</pre>`;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const first = document.querySelector('.diagram-panel.active');
      if (first) renderPanel(first);
    });
  </script>

</body>
</html>
