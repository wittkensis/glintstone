# v1 → v2 Schema Diff
# Quick reference for what changes between schema versions.

tables_added:
  - surfaces: "Explicit surface decomposition (was implicit text field)"
  - text_lines: "Per-line ATF records (was monolithic text blob)"
  - tokens: "Positional anchor linking all layers (did not exist)"
  - token_readings: "Competing transliterations per token position (trust primitive)"
  - lemmatizations: "Replaces lemmas — supports competing analyses"
  - morphology: "Structured morphological decomposition (was opaque string)"
  - annotation_runs: "Provenance tracking for all annotations (did not exist)"
  - scholars: "Individual scholarly contributors with expertise metadata (trust primitive)"
  - intertextuality_links: "Cross-text relationships (did not exist)"
  # Trust: Evidence tables (link annotations to supporting evidence)
  - token_reading_evidence: "Evidence for token readings (photographs, publications, etc.)"
  - lemmatization_evidence: "Evidence for lemmatizations"
  - sign_annotation_evidence: "Evidence for sign bounding box annotations"
  - translation_evidence: "Evidence for translations"
  # Trust: Decision tables (audit trail for consensus choices)
  - token_reading_decisions: "Audit trail for token reading consensus"
  - lemmatization_decisions: "Audit trail for lemmatization consensus"
  - translation_decisions: "Audit trail for translation consensus"
  # Annotation Ecosystem: Fragment Joins
  - join_groups: "N-way fragment join grouping (reconstructed tablets)"
  - fragment_joins: "Pairwise physical connections between artifacts with trust pipeline"
  - fragment_join_evidence: "Evidence supporting/refuting proposed joins"
  - fragment_join_decisions: "Audit trail for join acceptance/rejection"
  # Annotation Ecosystem: Scholarly Commentary
  - scholarly_annotations: "Cross-layer commentary with strict FK targeting and W3C export"
  - scholarly_annotation_evidence: "Evidence for scholarly annotations"
  # Annotation Ecosystem: Discussion Threads (per-entity strict FKs)
  - token_reading_discussion_threads: "Scholarly discourse on token readings"
  - lemmatization_discussion_threads: "Scholarly discourse on lemmatizations"
  - translation_discussion_threads: "Scholarly discourse on translations"
  - fragment_join_discussion_threads: "Scholarly discourse on proposed joins"
  - scholarly_annotation_discussion_threads: "Scholarly discourse on annotations"
  - discussion_posts: "Shared posts table for all discussion thread types"
  # Knowledge Graph: Named Entity Registry
  - named_entities: "Graph nodes — persons, deities, places, institutions extracted from lemmatizations"
  - entity_aliases: "Merge/alias records when duplicate entities identified"
  - entity_mentions: "Links tokens/lines to named entities with provenance"
  - entity_mention_evidence: "Evidence for entity identification"
  - entity_mention_decisions: "Audit trail for entity identification consensus"
  # Knowledge Graph: Entity Relationships
  - relationship_predicates: "Controlled vocabulary for stable relationship types (~13 Tier 1 predicates)"
  - entity_relationships: "Knowledge graph edges with hybrid predicate governance and temporal scope"
  - entity_relationship_evidence: "Evidence for entity relationships"
  - entity_relationship_decisions: "Audit trail for entity relationship consensus"
  # Knowledge Graph: Authority Reconciliation
  - authority_links: "Maps entities to external identifiers (Wikidata, VIAF, Pleiades, GeoNames)"
  - authority_reconciliation_disputes: "Records disagreements on authority links"
  # Citation Resolution: Identity Concordance (Layer 0)
  - artifact_identifiers: "N:1 alias concordance — any identifier resolves to P-number (replaces flat museum_no/excavation_no for lookup)"
  - artifact_identifier_evidence: "Evidence for identifier assignments (catalog entries, museum records)"
  - artifact_identifier_decisions: "Audit trail for disputed identifier assignments"
  # Citation Resolution: Publication Registry (Cross-cutting)
  - publications: "Structured bibliographic records with series membership and edition supersession chains"
  - publication_authors: "Structured authorship linking publications to scholars table"
  # Citation Resolution: Edition Bridge (Layer 0 / Trust)
  - artifact_editions: "Links artifacts to publications with page/plate refs, is_current_edition consensus flag, per-artifact supersedes chain"
  - artifact_edition_evidence: "Evidence for artifact-publication links"
  - artifact_edition_decisions: "Audit trail for is_current_edition designation"
  # Normalization Lookup Tables (from pressure testing)
  - period_canon: "Maps 46+ raw period formats to canonical names with BCE date ranges"
  - language_map: "Maps CDLI English names to ORACC ISO codes (Sumerian↔sux, Akkadian↔akk)"
  - genre_canon: "Normalizes genre case inconsistency to title-case canonical forms"
  - provenience_canon: "Separates ancient/modern site names, links to Pleiades"
  - surface_canon: "Unifies surface naming across ATF (@obverse), CompVis, ORACC"
  # Bibliometric (from citation pipeline review)
  - publication_citations: "Publication-to-publication citation links from Semantic Scholar"
  # Pipeline Internal (not in v2 schema proper)
  - _dedup_candidates: "Staging table for cross-source publication dedup (pipeline-internal, droppable)"

views_added:
  - scholarly_annotations_w3c: "W3C Web Annotation Data Model export for federation"
  - mv_language_stats: "Materialized view replacing v1 language_stats table"
  - mv_period_stats: "Materialized view replacing v1 period_stats table"
  - mv_provenience_stats: "Materialized view replacing v1 provenience_stats table"
  - mv_genre_stats: "Materialized view replacing v1 genre_stats table"
  - mv_pipeline_overview: "Dashboard view of data completeness by pipeline layer"

tables_removed:
  - lemmas: "Replaced by lemmatizations + tokens"
  - inscriptions: "Replaced by text_lines (may keep temporarily for backward compat)"
  - sign_word_usage: "Derivable from tokens + lemmatizations join"
  - language_stats: "Derivable from artifacts (materialized view instead)"
  - period_stats: "Derivable from artifacts (materialized view instead)"
  - provenience_stats: "Derivable from artifacts (materialized view instead)"
  - genre_stats: "Derivable from artifacts (materialized view instead)"

tables_expanded:
  artifacts:
    added_columns: [period_normalized, provenience_normalized, subgenre, supergenre, languages, pleiades_id, latitude, longitude, primary_publication, collection, dates_referenced, seal_id, cdli_updated_at, oracc_projects, annotation_run_id]
    removed_columns: []
    notes: "annotation_run_id added per pipeline review (unified provenance via annotation_runs, not data_source column)"

  signs:
    added_columns: [mzl_number, abz_number, lak_number, gdl_definition, total_corpus_frequency]
    removed_columns: []

  sign_values:
    added_columns: [language_context, period_context]
    removed_columns: []

  sign_annotations:
    added_columns: [surface_id, sign_id (resolved OGSL), damage_status, annotation_run_id]
    removed_columns: [p_number (now via surface_id → p_number), image_type, ref_image_width, ref_image_height (now on surfaces)]

  glossary_entries:
    added_columns: [periods, norms, annotation_run_id]
    removed_columns: [semantic_category (moved to semantic_fields join)]
    notes: "annotation_run_id added per pipeline review (unified provenance)"

  glossary_forms:
    added_columns: [norm, lang]

  glossary_senses:
    added_columns: [pos, signatures]
    removed_columns: [usage_context, frequency_percentage, example_lemma_ids]

  translations:
    added_columns: [line_id, annotation_run_id]

  pipeline_status:
    added_columns: [physical_complete, graphemic_complete, reading_complete, linguistic_complete, semantic_complete]
    removed_columns: [ocr_confidence, ocr_model, atf_source, lemma_coverage, translation_consensus (now derivable)]

  museums:
    added_columns: [latitude, longitude]

  excavation_sites:
    added_columns: [pleiades_id, latitude, longitude]

  import_log:
    added_columns: [annotation_run_id]

  annotation_runs:
    added_columns: [scholar_id, method, publication_ref, publication_id]
    removed_columns: []
    notes: "publication_id is nullable FK to publications table (incremental migration); publication_ref stays as freetext fallback"

  tokens:
    added_columns: []
    removed_columns: [form, reading, sign_function, damage, reading_confidence]
    notes: "Reading data moved to token_readings table. Token is now purely positional."

tables_unchanged:
  - composites
  - artifact_composites
  - sign_variants
  - glossary_relationships
  - semantic_fields
  - glossary_semantic_fields
  - cad_entries
  - cad_meanings
  - cad_examples
  - collections
  - collection_members
  - external_resources

key_architectural_shifts:
  - from: "One lemmatization per word"
    to: "Multiple competing lemmatizations per token with provenance"

  - from: "ATF as text blob on inscriptions table"
    to: "Decomposed into surfaces → text_lines → tokens"

  - from: "No annotation source tracking"
    to: "Every annotation links to annotation_runs (human/model/import)"

  - from: "Sign identity by mixed label formats"
    to: "All sign references resolved to OGSL sign_id via concordance"

  - from: "Flat metadata"
    to: "Layered completeness tracking (physical/graphemic/reading/linguistic/semantic)"

  - from: "Opaque morph string"
    to: "Structured morphology table with language-specific slots"

  - from: "Single reading per token position"
    to: "Competing readings via token_readings with provenance and consensus tracking"

  - from: "No scholar-level attribution"
    to: "scholars table + scholar_id on annotation_runs — who read this, how, and where published"

  - from: "is_consensus as bare flag"
    to: "Decision tables with rationale, method, and supersedes chain for full audit trail"

  - from: "No evidence linking"
    to: "Per-entity evidence tables connecting annotations to photographs, publications, collation notes"

  - from: "No fragment join tracking"
    to: "fragment_joins + join_groups with full evidence/decision trust pipeline and N-way grouping"

  - from: "No general-purpose scholarly commentary"
    to: "scholarly_annotations with strict FK targeting, versioning, and W3C Web Annotation export"

  - from: "No structured scholarly discussion"
    to: "Per-entity discussion_threads with shared discussion_posts — captures discourse that produces consensus"

  - from: "No named entity tracking"
    to: "named_entities registry with entity_mentions linking tokens to persons, deities, places — bridges Layer 4 (Linguistic) to Layer 5 (Semantic)"

  - from: "No entity relationships"
    to: "entity_relationships with hybrid predicate governance (Tier 1 enum + Tier 2-3 freetext), temporal scope via period names, full evidence/decision trust chain"

  - from: "No external authority linking"
    to: "authority_links maps entities to Wikidata, VIAF, Pleiades, GeoNames with reconciliation disputes for scholarly disagreement"

  - from: "Flat museum_no/excavation_no columns, no structured publication tracking"
    to: "artifact_identifiers N:1 concordance + publications registry + artifact_editions bridge — dual resolution path (fast identifier lookup + rich edition metadata) with per-artifact supersedes chains and is_current_edition consensus"

  - from: "Freetext publication_ref on annotation_runs"
    to: "Structured publication_id FK alongside freetext fallback — every reading/lemmatization/annotation can link to a real bibliographic record"

  # Added from pressure testing & citation pipeline review
  - from: "No normalization lookup tables"
    to: "period_canon, language_map, genre_canon, provenience_canon, surface_canon — standardize 46+ period formats, language codes, genres, site names, surface names"

  - from: "No cross-source publication deduplication"
    to: "Cascading dedup (DOI→bibtex_key→title+year→short_title+volume) with _dedup_candidates staging table, source-prefixed bibtex_keys (keibi:, oracc:, ebl:, openalex:)"

  - from: "No citation graph data"
    to: "publication_citations table for Semantic Scholar bibliometric edges, cited_by_count on publications"

  - from: "data_source column proposed for provenance"
    to: "Withdrawn — annotation_runs.source_name is the single provenance system. annotation_run_id FK added to artifacts and glossary_entries."
